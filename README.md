# VPS Media Server

–°–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥–æ–≤—ã–π –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä –Ω–∞ Docker Compose —Å REST API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏ –ø—É–±–ª–∏—á–Ω–æ–π —Ä–∞–∑–¥–∞—á–∏ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Nginx.

## üéÜ –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —Å–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥–∞ –Ω–∞ VPS:

- ‚úÖ **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** - –Ω–∏–∫–∞–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ª–∏–º–∏—Ç–æ–≤
- ‚úÖ **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏** - –Ω–∏–∫–∞–∫–∏—Ö Pro-–ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–∑–¥–∞—á–∞ —á–µ—Ä–µ–∑ Nginx
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - Docker Compose –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
- ‚úÖ **–ê–≤—Ç–æ–¥–µ–ø–ª–æ–π** - GitHub Actions –Ω–∞ VPS

## üè† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **Nginx** (–ø–æ—Ä—Ç 8081) - —Ä–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏ reverse proxy
- **FastAPI** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π 8002) - REST API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **–ò–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä** - Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏—è JSON –∫–∞—Ç–∞–ª–æ–≥–∞

### –ü–æ—Ä—Ç—ã:
- üåê **8081** - –ø—É–±–ª–∏—á–Ω—ã–π HTTP (—Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç)
- üîí **8002** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API (—Ç–æ–ª—å–∫–æ –≤ Docker network)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏
```bash
git clone -b vps-media-server https://github.com/KomarovAI/file-sync.git vps-media-server
cd vps-media-server
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ:**
```env
PUBLIC_BASE_URL=http://your-vps-ip:8081
API_TOKEN=your-secure-random-token
CORS_ORIGINS=https://yourdomain.com
```

### 3. –ó–∞–ø—É—Å–∫
```bash
make build
make up
# –∏–ª–∏
docker-compose up -d
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞
```bash
curl http://localhost:8081/healthz
curl http://localhost:8081/api/media
```

## üì° API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ü—É–±–ª–∏—á–Ω—ã–µ:
```bash
# –ö–∞—Ç–∞–ª–æ–≥ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
GET /api/media
GET /api/media?type=image&size_max=10000000

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
GET /api/stats

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
GET /healthz

# JSON –∫–∞—Ç–∞–ª–æ–≥ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
GET /index/media_links.json
```

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ (Bearer —Ç–æ–∫–µ–Ω):
```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
POST /api/upload
Authorization: Bearer your-api-token
Content-Type: multipart/form-data

# –ü—Ä–∏–º–µ—Ä:
curl -X POST \
  -H "Authorization: Bearer your-token" \
  -F "file=@photo.jpg" \
  -F "subdir=images" \
  http://localhost:8081/api/upload
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–¥–∏–∞

```
/srv/media/
‚îú‚îÄ‚îÄ images/          # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ videos/          # –í–∏–¥–µ–æ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ audio/           # –ê—É–¥–∏–æ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docs/            # –î–æ–∫—É–º–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ uploads/         # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
‚îî‚îÄ‚îÄ index/
    ‚îî‚îÄ‚îÄ media_links.json  # JSON –∫–∞—Ç–∞–ª–æ–≥
```

## üìã –§–æ—Ä–º–∞—Ç JSON –∫–∞—Ç–∞–ª–æ–≥–∞

```json
{
  "media_files": [
    {
      "id": "unique_hash",
      "name": "example.jpg",
      "url": "http://your-vps:8081/images/example.jpg",
      "type": "image",
      "mime_type": "image/jpeg",
      "size": 1234567,
      "path": "/images/example.jpg",
      "md5": "hash",
      "created": "2025-10-29T12:00:00Z",
      "modified": "2025-10-29T12:00:00Z"
    }
  ],
  "total_files": 1,
  "total_size": 1234567,
  "last_updated": "2025-10-29T12:00:00Z",
  "version": "1.0"
}
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º

### JavaScript (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ!):
```javascript
// –¢–æ—Ç –∂–µ –∫–æ–¥, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ, —Ç–æ–ª—å–∫–æ URL –∏–∑–º–µ–Ω–∏–ª—Å—è!
const response = await fetch('http://your-vps:8081/index/media_links.json');
const mediaData = await response.json();

mediaData.media_files.forEach(file => {
  if (file.type === 'image') {
    const img = document.createElement('img');
    img.src = file.url;  // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ Nginx!
    gallery.appendChild(img);
  }
});
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API:
```javascript
// –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const images = await fetch('http://your-vps:8081/api/media?type=image');

// –§–∞–π–ª—ã –º–µ–Ω—å—à–µ 10 –ú–ë
const small = await fetch('http://your-vps:8081/api/media?size_max=10485760');
```

## üîß –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ
make build          # –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã
make up             # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
make down           # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
make logs           # –õ–æ–≥–∏

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
make status         # –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
make test           # –ü—Ä–æ–≤–µ—Ä–∫–∞ API

# –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
make index          # –†—É—á–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
make backup         # –ë—ç–∫–∞–ø –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
make clean          # –û—á–∏—Å—Ç–∫–∞

# –û—Ç–ª–∞–¥–∫–∞
make shell-api      # Shell –≤ API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
make shell-nginx    # Shell –≤ Nginx
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- üîë **API —Ç–æ–∫–µ–Ω** –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
- üìã **MIME –≤–∞–ª–∏–¥–∞—Ü–∏—è** –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
- üìÅ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
- üåê **CORS** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤
- üö´ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞** —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## üöÄ –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–∞ VPS

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ GitHub Actions.

### –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:
‚úÖ `VPS_HOST` - IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ VPS  
‚úÖ `VPS_USER` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SSH (root)  
‚úÖ `VPS_SSH_KEY` - –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á  
‚úÖ `VPS_PORT` - –ø–æ—Ä—Ç SSH (22)

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. üîÑ **Push** –≤ –≤–µ—Ç–∫—É `vps-media-server`
2. üîß **GitHub Actions** —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –ø–æ SSH
3. üì¶ **–û–±–Ω–æ–≤–ª—è–µ—Ç** –∫–æ–¥ –∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
4. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç** —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å API

### –ú–∞–Ω—É–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π:
```bash
# –ù–∞ VPS:
cd /opt/file-sync
git pull origin vps-media-server
docker-compose up -d --build
```

## üìä Production –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. HTTPS
–î–æ–±–∞–≤—å—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ nginx.conf –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Traefik/Caddy

### 2. –î–æ–º–µ–Ω
```env
PUBLIC_BASE_URL=https://media.yourdomain.com
```

### 3. –ë—ç–∫–∞–ø—ã
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
0 2 * * * cd /opt/file-sync && make backup
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# Healthcheck
curl http://your-vps:8081/healthz

# –õ–æ–≥–∏
docker-compose logs -f --tail=100
```

## üìú –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏

–ü—Ä–æ–µ–∫—Ç **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º:

- ‚úÖ **–¢–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç** media_links.json
- ‚úÖ **–¢–µ –∂–µ –ø–æ–ª—è** –≤ JSON –æ–±—ä–µ–∫—Ç–∞—Ö
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ —Å–º–µ–Ω–∏—Ç–µ URL** –≤ —Å–≤–æ–µ–º fetch()

–ò–∑–º–µ–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ:
```javascript
// –ë—ã–ª–æ:
fetch('https://raw.githubusercontent.com/KomarovAI/file-sync/main/media_links.json')

// –°—Ç–∞–ª–æ:
fetch('http://your-vps:8081/index/media_links.json')
```

## üèÜ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ü—Ä–æ—Ç–∏–≤ –æ–±–ª–∞—á–Ω—ã—Ö API:
- ‚ùå **Filen.io** - Pro-–ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
- ‚úÖ **VPS Media Server** - –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤!

### –ü—Ä–æ—Ç–∏–≤ –æ–±—ã—á–Ω–æ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞:
- ‚úÖ **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ —Ñ–∞–π–ª–∞–º–∏
- ‚úÖ **REST API** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- üìö [FastAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://fastapi.tiangolo.com/)
- üê≥ [Docker Compose –≥–∞–π–¥](https://docs.docker.com/compose/)
- üåê [Nginx –∫–æ–Ω—Ñ–∏–≥](https://nginx.org/ru/docs/)
- üîß [GitHub Actions](https://docs.github.com/actions)

## üéÜ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- üîí **HTTPS** —Å Let's Encrypt
- üåç **CDN** –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** Prometheus + Grafana
- üó∫Ô∏è **Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- üì¶ **MinIO S3** –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

**–õ–∏—Ü–µ–Ω–∑–∏—è:** MIT | **–ê–≤—Ç–æ—Ä:** KomarovAI